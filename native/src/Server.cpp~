#include "Server.h"
#include "ServerBackend.h"
#include <iostream>

ConHandler::pointer ConHandler::create(asio::io_service& io_service) { return pointer(new ConHandler(io_service)); }  
ConHandler::ConHandler(asio::io_service& io_service): socket(io_service) {}    
tcp::socket& ConHandler::getSocket() { return socket; }  

void ConHandler::start() {  
  socket.async_read_some(asio::buffer(backend.getMsgBuff(), length), bind(&ConHandler::handleRead, shared_from_this(), boost_err_placeholder, boost_bt_placeholder));
  //socket.async_write_some(asio::buffer(message, length), bind(&ConHandler::handleWrite, shared_from_this(), boost_err_placeholder, boost_bt_placeholder));
}  
  
void ConHandler::handleRead(const boost_err& err, size_t bytes_transferred){  
  if (err) {  
    std::cerr << "error: " << err.message() << std::endl;
    socket.close();
  }   
  else {  
    std::cout << backend.getMsgBuff() << std::endl;
  }
}  
void ConHandler::handleWrite(const boost_err& err, size_t bytes_transferred){  
  if (!err) {  
    std::cout << "Server sent Hello message!"<< std::endl;  
  }   
  else {  
    std::cerr << "error: " << err.message() << std::endl;  
    socket.close();  
  }  
}  

void Server::startAccept() {  
  // socket  
  ConHandler::pointer connection = ConHandler::create(*io_service);  
  // asynchronous accept operation and wait for a new connection.  
  acceptor.async_accept(connection->getSocket(), bind(&Server::handleAccept, this, connection, boost_err_placeholder));  
}  

Server::Server(asio::io_service& io_service): io_service(&io_service), acceptor(io_service, tcp::endpoint(tcp::v4(), serverPort)) {
  // Verbindungen sofort annehmen
  startAccept();
}           

void Server::handleAccept(ConHandler::pointer connection, const boost_err& err){  
  if (!err) {  
    connection->start();  
  }
  startAccept();  
}
